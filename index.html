<!DOCTYPE html>
<html>
<head>
    <title>ANGKABET TRUSTED</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
        }
        
        /* Note Section Styles */
        .note-container {
            background-color: #f8f9fa;
            border-left: 6px solid #4CAF50;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .note-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }
        .rewards-table {
            width: 100%;
            border-collapse: collapse;
        }
        .rewards-table th {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            text-align: center;
        }
        .rewards-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .rewards-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        /* Spreadsheet Styles */
        .spreadsheet-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        #claimsTable {
            border-collapse: collapse;
            width: 100%;
        }
        #claimsTable th, #claimsTable td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: center;
            min-width: 120px;
        }
        #claimsTable th {
            background-color: #F2F2F2;
            position: sticky;
            top: 0;
        }
        #claimsTable tr:nth-child(even) {
            background-color: #F9F9F9;
        }
        
        /* Status Styles */
        .status-waiting {
            background-color: #FFF3CD;
        }
        .status-done {
            background-color: #D4EDDA;
        }
        .duplicate-ticket {
            background-color: #FFCCCC !important;
            font-weight: bold;
        }
        .exceed-limit {
            background-color: #FF6666 !important;
            color: white;
            font-weight: bold;
        }
        input.exceed-limit {
            background-color: #FF6666 !important;
            color: white;
            font-weight: bold;
        }
        
        /* Other Styles */
        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .image-preview {
            max-width: 100px;
            max-height: 60px;
            cursor: pointer;
        }
        .warning-message {
            color: red;
            margin-top: 10px;
            font-weight: bold;
        }
        button {
            padding: 8px 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        input, select {
            padding: 6px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>SCATTER MAHYONG WAYS 1 & 2 ANGKABET</h1>
        <button onclick="addNewRow()">+ Tambah Baris</button>
    </div>

    <!-- Scatter Rewards Table -->
    <div class="note-container">
        <div class="note-title">üìù CLAIM GRUP LINE :</div>
        <table class="rewards-table">
            <thead>
                <tr>
                    <th>Jumlah Scatter</th>
                    <th>Betting (400-800)</th>
                    <th>Betting (1.200-1.400)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>üé∞ 3 Scatter</td>
                    <td>Rp.8.000</td>
                    <td>Rp.20.000</td>
                </tr>
                <tr>
                    <td>üé∞ 4 Scatter</td>
                    <td>Rp.15.000</td>
                    <td>Rp.30.000</td>
                </tr>
                <tr>
                    <td>üé∞ 5 Scatter</td>
                    <td>Rp.50.000</td>
                    <td>Rp.80.000</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="note-container">
        <div class="note-title">üìù CLAIM LIVE CHAT :</div>
        <table class="rewards-table">
            <thead>
                <tr>
                    <th>Jumlah Scatter</th>
                    <th>Betting (1.600-1.800)</th>
                    <th>Betting (2.000-8.000)</th>
                    <th>Betting (10.000-18.000)</th>
                    <th>Betting (20.000-100.000)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>üé∞ 3 Scatter</td>
                    <td>Rp.30.000</td>
                    <td>Rp.50.000</td>
                    <td>Rp.80.000</td>
                    <td>Rp.100.000</td>
                </tr>
                <tr>
                    <td>üé∞ 4 Scatter</td>
                    <td>Rp.60.000</td>
                    <td>Rp.100.000</td>
                    <td>Rp.160.000</td>
                    <td>Rp.300.000</td>
                </tr>
                <tr>
                    <td>üé∞ 5 Scatter</td>
                    <td>Rp.150.000</td>
                    <td>Rp.200.000</td>
                    <td>Rp.300.000</td>
                    <td>Rp.500.000</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="warningMessage" class="warning-message"></div>
    
    <div class="spreadsheet-container">
        <table id="claimsTable">
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>User ID</th>
                    <th>Nama Rekening</th>
                    <th>Nomor Rekening</th>
                    <th>Kode Tiket</th>
                    <th>Nominal Betting</th>
                    <th>Nominal Claim</th>
                    <th>Status</th>
                    <th>Claim Via</th>
                    <th>Screenshot Scatter</th>
                    <th>Screenshot Kemenangan</th>
                    <th>Total Claim Livechat</th>
                    <th>Total Claim Grup LINE</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data akan diisi oleh JavaScript -->
            </tbody>
        </table>
    </div>
    
    <div class="action-buttons">
        <button onclick="saveData()">Simpan Data</button>
        <button onclick="exportToExcel()">Export ke Excel</button>
        <button onclick="calculateTotals()">Hitung Total</button>
    </div>

    <script>
        // Track claim counts per user per channel
        let userClaimStats = {};
        const MAX_CLAIMS_PER_CHANNEL = 3;
        
        // Tambah baris baru
        function addNewRow() {
            const tbody = document.querySelector('#claimsTable tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="date" style="width: 120px;"></td>
                <td><input type="text" placeholder="USER123" oninput="validateUserClaims(); calculateTotals();"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text" oninput="checkDuplicateTickets()"></td>
                <td><input type="number" min="400"></td>
                <td><input type="number"></td>
                <td>
                    <select onchange="updateRowStatus(this); validateUserClaims(); calculateTotals()">
                        <option value="Waiting" selected>Waiting</option>
                        <option value="Done">Done</option>
                    </select>
                </td>
                <td>
                    <select onchange="validateUserClaims(); calculateTotals();">
                        <option value="Livechat">Livechat</option>
                        <option value="LINE">LINE</option>
                    </select>
                </td>
                <td>
                    <input type="file" accept="image/*" onchange="previewImage(this)">
                    <img src="" class="image-preview" style="display: none;">
                </td>
                <td>
                    <input type="file" accept="image/*" onchange="previewImage(this)">
                    <img src="" class="image-preview" style="display: none;">
                </td>
                <td><input type="number" value="0" readonly></td>
                <td><input type="number" value="0" readonly></td>
                <td><button onclick="deleteRow(this)" style="background-color: #f44336;">Hapus</button></td>
            `;
            tbody.appendChild(newRow);
        }

        // Validasi claim count per user per channel (untuk semua status)
        function validateUserClaims() {
            const rows = document.querySelectorAll('#claimsTable tbody tr');
            userClaimStats = {};
            let warningMessage = '';
            
            // Hitung claim per user per channel
            rows.forEach(row => {
                const userId = row.querySelector('td:nth-child(2) input').value.trim();
                const claimVia = row.querySelector('td:nth-child(9) select').value;
                
                if (userId) {
                    if (!userClaimStats[userId]) {
                        userClaimStats[userId] = { Livechat: 0, LINE: 0 };
                    }
                    userClaimStats[userId][claimVia]++;
                }
            });

            // Update highlight untuk yang melebihi limit
            rows.forEach(row => {
                const userIdCell = row.querySelector('td:nth-child(2)');
                const userIdInput = userIdCell.querySelector('input');
                const userId = userIdInput.value.trim();
                const claimVia = row.querySelector('td:nth-child(9) select').value;

                // Reset highlight
                userIdCell.classList.remove('exceed-limit');
                userIdInput.classList.remove('exceed-limit');
                
                // Beri warna merah jika melebihi limit
                if (userId && userClaimStats[userId]) {
                    if (userClaimStats[userId][claimVia] > MAX_CLAIMS_PER_CHANNEL) {
                        userIdCell.classList.add('exceed-limit');
                        userIdInput.classList.add('exceed-limit');
                        warningMessage = `PERINGATAN: User ${userId} melebihi batas claim (maksimal ${MAX_CLAIMS_PER_CHANNEL}x per channel)!`;
                    }
                }
            });

            document.getElementById('warningMessage').textContent = warningMessage;
        }

        // Cek duplikat kode tiket
        function checkDuplicateTickets() {
            const ticketCodes = {};
            const rows = document.querySelectorAll('#claimsTable tbody tr');
            
            rows.forEach(row => {
                const ticketInput = row.querySelector('td:nth-child(5) input');
                const ticketCode = ticketInput.value.trim();
                if (ticketCode) {
                    if (!ticketCodes[ticketCode]) {
                        ticketCodes[ticketCode] = [];
                    }
                    ticketCodes[ticketCode].push(row);
                }
            });

            // Reset semua highlight duplikat
            rows.forEach(row => {
                const ticketCell = row.querySelector('td:nth-child(5)');
                ticketCell.classList.remove('duplicate-ticket');
                ticketCell.querySelector('input').classList.remove('duplicate-ticket');
            });

            // Highlight duplikat
            for (const code in ticketCodes) {
                if (ticketCodes[code].length > 1) {
                    ticketCodes[code].forEach(row => {
                        const ticketCell = row.querySelector('td:nth-child(5)');
                        ticketCell.classList.add('duplicate-ticket');
                        ticketCell.querySelector('input').classList.add('duplicate-ticket');
                    });
                }
            }
        }

        // Preview gambar
        function previewImage(input) {
            const imgPreview = input.nextElementSibling;
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imgPreview.src = e.target.result;
                    imgPreview.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                imgPreview.src = '';
                imgPreview.style.display = 'none';
            }
        }

        // Update status row
        function updateRowStatus(select) {
            const row = select.closest('tr');
            row.classList.remove('status-waiting', 'status-done', 'exceed-limit');
            if (select.value === 'Waiting') {
                row.classList.add('status-waiting');
            } else {
                row.classList.add('status-done');
            }
            // Reset highlight input juga
            const userIdInput = row.querySelector('td:nth-child(2) input');
            userIdInput.classList.remove('exceed-limit');
            
            validateUserClaims();
        }

        // Hapus baris
        function deleteRow(button) {
            const row = button.closest('tr');
            row.remove();
            validateUserClaims();
            calculateTotals();
            checkDuplicateTickets();
        }

        // Hitung total claim (termasuk yang status Waiting)
        function calculateTotals() {
            const rows = document.querySelectorAll('#claimsTable tbody tr');
            let totalLivechat = 0;
            let totalLine = 0;
            let userClaims = {}; // Untuk melacak claim per user
            
            // Reset semua total claim terlebih dahulu
            rows.forEach(row => {
                row.querySelector('td:nth-child(12) input').value = 0;
                row.querySelector('td:nth-child(13) input').value = 0;
            });
            
            // Hitung ulang semua claim
            rows.forEach(row => {
                const userId = row.querySelector('td:nth-child(2) input').value.trim();
                const claimVia = row.querySelector('td:nth-child(9) select').value;
                
                if (!userId) return; // Skip jika user ID kosong
                
                if (!userClaims[userId]) {
                    userClaims[userId] = { Livechat: 0, LINE: 0 };
                }
                
                // Hitung claim per user (maksimal 3 per channel)
                if (userClaims[userId][claimVia] < MAX_CLAIMS_PER_CHANNEL) {
                    if (claimVia === 'Livechat') {
                        totalLivechat++;
                        userClaims[userId].Livechat++;
                        row.querySelector('td:nth-child(12) input').value = 1;
                    } else {
                        totalLine++;
                        userClaims[userId].LINE++;
                        row.querySelector('td:nth-child(13) input').value = 1;
                    }
                }
            });
            
            console.log(`Total Livechat: ${totalLivechat}, Total LINE: ${totalLine}`);
        }

        // Simpan data ke localStorage
        function saveData() {
            const rows = document.querySelectorAll('#claimsTable tbody tr');
            const data = [];
            
            rows.forEach(row => {
                const rowData = {
                    date: row.querySelector('td:nth-child(1) input').value,
                    userId: row.querySelector('td:nth-child(2) input').value,
                    accountName: row.querySelector('td:nth-child(3) input').value,
                    accountNumber: row.querySelector('td:nth-child(4) input').value,
                    ticketCode: row.querySelector('td:nth-child(5) input').value,
                    betAmount: row.querySelector('td:nth-child(6) input').value,
                    claimAmount: row.querySelector('td:nth-child(7) input').value,
                    status: row.querySelector('td:nth-child(8) select').value,
                    claimVia: row.querySelector('td:nth-child(9) select').value,
                    scatterImage: row.querySelector('td:nth-child(10) img').src,
                    winImage: row.querySelector('td:nth-child(11) img').src
                };
                data.push(rowData);
            });
            
            localStorage.setItem('scatterClaimsData', JSON.stringify(data));
            alert('Data berhasil disimpan!');
        }

        // Export ke Excel
        function exportToExcel() {
            const rows = document.querySelectorAll('#claimsTable tr');
            let csv = [];
            
            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('th, td');
                
                cells.forEach(cell => {
                    if (cell.querySelector('input')) {
                        rowData.push(cell.querySelector('input').value);
                    } else if (cell.querySelector('select')) {
                        rowData.push(cell.querySelector('select').value);
                    } else if (cell.querySelector('img') && cell.querySelector('img').src) {
                        rowData.push('Image Attached');
                    } else if (!cell.querySelector('button')) {
                        rowData.push(cell.textContent.trim());
                    }
                });
                
                csv.push(rowData.join(','));
            });

            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'scatter_claims.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', function() {
            addNewRow(); // Tambah baris kosong pertama
            
            // Load saved data if exists
            const savedData = localStorage.getItem('scatterClaimsData');
            if (savedData) {
                const data = JSON.parse(savedData);
                data.forEach(item => {
                    addNewRow();
                    const rows = document.querySelectorAll('#claimsTable tbody tr');
                    const lastRow = rows[rows.length - 1];
                    
                    lastRow.querySelector('td:nth-child(1) input').value = item.date;
                    lastRow.querySelector('td:nth-child(2) input').value = item.userId;
                    lastRow.querySelector('td:nth-child(3) input').value = item.accountName;
                    lastRow.querySelector('td:nth-child(4) input').value = item.accountNumber;
                    lastRow.querySelector('td:nth-child(5) input').value = item.ticketCode;
                    lastRow.querySelector('td:nth-child(6) input').value = item.betAmount;
                    lastRow.querySelector('td:nth-child(7) input').value = item.claimAmount;
                    lastRow.querySelector('td:nth-child(8) select').value = item.status;
                    lastRow.querySelector('td:nth-child(9) select').value = item.claimVia;
                    
                    if (item.scatterImage) {
                        lastRow.querySelector('td:nth-child(10) img').src = item.scatterImage;
                        lastRow.querySelector('td:nth-child(10) img').style.display = 'block';
                    }
                    
                    if (item.winImage) {
                        lastRow.querySelector('td:nth-child(11) img').src = item.winImage;
                        lastRow.querySelector('td:nth-child(11) img').style.display = 'block';
                    }
                    
                    updateRowStatus(lastRow.querySelector('td:nth-child(8) select'));
                });
                
                validateUserClaims();
                calculateTotals();
                checkDuplicateTickets();
            }

            // Tambahkan event listener untuk perubahan data
            document.querySelector('#claimsTable').addEventListener('input', function(e) {
                if (e.target.matches('td:nth-child(2) input') || // User ID
                    e.target.matches('td:nth-child(9) select')) { // Claim Via
                    validateUserClaims();
                    calculateTotals();
                }
            });
        });
    </script>
</body>
</html>
